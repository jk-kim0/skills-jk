#!/bin/bash
set -o errexit -o nounset -o pipefail

# Credentials: set CONFLUENCE_CREDS environment variable or use config file
# Format: email:api_token
if [[ -z "${CONFLUENCE_CREDS:-}" ]]; then
  CONFIG_FILE="${HOME}/.config/atlassian/confluence.conf"
  if [[ -f "$CONFIG_FILE" ]]; then
    CREDS=$(cat "$CONFIG_FILE")
  else
    echo "Error: CONFLUENCE_CREDS not set and config file not found"
    echo "Set CONFLUENCE_CREDS=email:api_token or create $CONFIG_FILE"
    exit 1
  fi
else
  CREDS="$CONFLUENCE_CREDS"
fi

BASE_URL="${CONFLUENCE_BASE_URL:-https://querypie.atlassian.net/wiki}"

api_call() {
  curl -s --user "$CREDS" "${BASE_URL}$1"
}

api_post() {
  curl -s --user "$CREDS" -X POST -H "Content-Type: application/json" -d @- "${BASE_URL}$1"
}

api_put() {
  curl -s --user "$CREDS" -X PUT -H "Content-Type: application/json" -d @- "${BASE_URL}$1"
}

cmd="${1:-help}"

if [[ "$cmd" == "spaces" ]]; then
  api_call "/rest/api/space?limit=100&type=global" | python3 -c "
import sys, json
data = json.load(sys.stdin)
fmt = '{:<15} {:<40} {:<10}'
print(fmt.format('Key', 'Name', 'Status'))
print('-' * 65)
for s in data.get('results', []):
    key = s['key']
    name = s['name'][:38]
    status = s['status']
    print(fmt.format(key, name, status))
"

elif [[ "$cmd" == "search" ]]; then
  query="${2:-}"
  if [[ -z "$query" ]]; then
    echo "Usage: confluence search <query>"
    exit 1
  fi
  encoded=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$query'''))")
  api_call "/rest/api/content/search?cql=text~${encoded}&limit=10" | python3 -c "
import sys, json
data = json.load(sys.stdin)
fmt = '{:<12} {:<50} {:<15}'
print(fmt.format('ID', 'Title', 'Space'))
print('-' * 80)
for p in data.get('results', []):
    space = p.get('_expandable', {}).get('space', '').split('/')[-1]
    pid = p['id']
    title = p['title'][:48]
    print(fmt.format(pid, title, space))
"

elif [[ "$cmd" == "page" ]]; then
  page_id="${2:-}"
  if [[ -z "$page_id" ]]; then
    echo "Usage: confluence page <pageId>"
    exit 1
  fi
  api_call "/rest/api/content/${page_id}?expand=body.storage,space,ancestors" | python3 -c "
import sys, json, html, re
data = json.load(sys.stdin)
title = data.get('title', 'Unknown')
space = data.get('space', {}).get('name', 'Unknown')
space_key = data.get('space', {}).get('key', 'Unknown')
ancestors = data.get('ancestors', [])
body_html = data.get('body', {}).get('storage', {}).get('value', '')
body = re.sub(r'<[^>]+>', ' ', body_html)
body = html.unescape(body)
body = re.sub(r'\s+', ' ', body).strip()
print('Title:', title)
print('Space:', space, f'({space_key})')
print('ID:', data.get('id', 'Unknown'))
if ancestors:
    print('Parent ID:', ancestors[-1].get('id', 'Unknown'))
print()
print('Content:')
print('-' * 60)
print(body[:3000])
if len(body) > 3000:
    print('...(truncated)')
"

elif [[ "$cmd" == "create" ]]; then
  # Usage: confluence create <spaceKey> <parentId> <title> <markdown_file>
  space_key="${2:-}"
  parent_id="${3:-}"
  title="${4:-}"
  md_file="${5:-}"

  if [[ -z "$space_key" || -z "$parent_id" || -z "$title" || -z "$md_file" ]]; then
    echo "Usage: confluence create <spaceKey> <parentId> <title> <markdown_file>"
    echo ""
    echo "Example:"
    echo "  confluence create ~712020xxx 506822712 'My Page Title' ./report.md"
    exit 1
  fi

  if [[ ! -f "$md_file" ]]; then
    echo "Error: File not found: $md_file"
    exit 1
  fi

  # Convert markdown to Confluence format and create JSON payload
  python3 -c "
import sys
import re
import json

with open('$md_file', 'r') as f:
    content = f.read()

# Headers
content = re.sub(r'^###### (.+)$', r'<h6>\1</h6>', content, flags=re.MULTILINE)
content = re.sub(r'^##### (.+)$', r'<h5>\1</h5>', content, flags=re.MULTILINE)
content = re.sub(r'^#### (.+)$', r'<h4>\1</h4>', content, flags=re.MULTILINE)
content = re.sub(r'^### (.+)$', r'<h3>\1</h3>', content, flags=re.MULTILINE)
content = re.sub(r'^## (.+)$', r'<h2>\1</h2>', content, flags=re.MULTILINE)
content = re.sub(r'^# (.+)$', r'<h1>\1</h1>', content, flags=re.MULTILINE)

# Bold and italic
content = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', content)
content = re.sub(r'(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)', r'<em>\1</em>', content)

# Horizontal rule
content = re.sub(r'^---+$', r'<hr/>', content, flags=re.MULTILINE)

# Simple table conversion
lines = content.split('\n')
result = []
in_table = False
table_rows = []

for line in lines:
    if '|' in line and line.strip().startswith('|'):
        if not in_table:
            in_table = True
            table_rows = []
        # Skip separator lines
        if re.match(r'^\|[\s\-:|]+\|$', line.strip()):
            continue
        cells = [c.strip() for c in line.strip().split('|')[1:-1]]
        table_rows.append(cells)
    else:
        if in_table:
            # Output table
            result.append('<table><tbody>')
            for i, row in enumerate(table_rows):
                tag = 'th' if i == 0 else 'td'
                result.append('<tr>' + ''.join(f'<{tag}>{c}</{tag}>' for c in row) + '</tr>')
            result.append('</tbody></table>')
            in_table = False
            table_rows = []
        result.append(line)

if in_table:
    result.append('<table><tbody>')
    for i, row in enumerate(table_rows):
        tag = 'th' if i == 0 else 'td'
        result.append('<tr>' + ''.join(f'<{tag}>{c}</{tag}>' for c in row) + '</tr>')
    result.append('</tbody></table>')

content = '\n'.join(result)

# Paragraphs - wrap non-tag lines
final_lines = []
for line in content.split('\n'):
    stripped = line.strip()
    if stripped and not stripped.startswith('<') and not stripped.endswith('>'):
        final_lines.append(f'<p>{line}</p>')
    else:
        final_lines.append(line)
content = '\n'.join(final_lines)

payload = {
    'type': 'page',
    'title': '$title',
    'space': {'key': '$space_key'},
    'ancestors': [{'id': '$parent_id'}],
    'body': {
        'storage': {
            'value': content,
            'representation': 'storage'
        }
    }
}

print(json.dumps(payload))
" | api_post "/rest/api/content" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'id' in data:
    print('Page created successfully!')
    print('ID:', data['id'])
    print('Title:', data['title'])
    link = data.get('_links', {}).get('webui', '')
    if link:
        print('URL: https://querypie.atlassian.net/wiki' + link)
else:
    print('Error:', data.get('message', 'Unknown error'))
    if 'data' in data:
        print('Details:', data.get('data', {}).get('errors', []))
"

elif [[ "$cmd" == "update" ]]; then
  # Usage: confluence update <pageId> <markdown_file>
  page_id="${2:-}"
  md_file="${3:-}"

  if [[ -z "$page_id" || -z "$md_file" ]]; then
    echo "Usage: confluence update <pageId> <markdown_file>"
    exit 1
  fi

  if [[ ! -f "$md_file" ]]; then
    echo "Error: File not found: $md_file"
    exit 1
  fi

  # Get current page info (for version number and title)
  page_info=$(api_call "/rest/api/content/${page_id}?expand=version")
  current_version=$(echo "$page_info" | python3 -c "import sys,json; print(json.load(sys.stdin).get('version',{}).get('number',1))")
  current_title=$(echo "$page_info" | python3 -c "import sys,json; print(json.load(sys.stdin).get('title',''))")
  new_version=$((current_version + 1))

  # Convert markdown to Confluence format and create JSON payload
  python3 -c "
import sys
import re
import json

with open('$md_file', 'r') as f:
    content = f.read()

# Headers
content = re.sub(r'^###### (.+)$', r'<h6>\1</h6>', content, flags=re.MULTILINE)
content = re.sub(r'^##### (.+)$', r'<h5>\1</h5>', content, flags=re.MULTILINE)
content = re.sub(r'^#### (.+)$', r'<h4>\1</h4>', content, flags=re.MULTILINE)
content = re.sub(r'^### (.+)$', r'<h3>\1</h3>', content, flags=re.MULTILINE)
content = re.sub(r'^## (.+)$', r'<h2>\1</h2>', content, flags=re.MULTILINE)
content = re.sub(r'^# (.+)$', r'<h1>\1</h1>', content, flags=re.MULTILINE)

# Bold and italic
content = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', content)
content = re.sub(r'(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)', r'<em>\1</em>', content)

# Horizontal rule
content = re.sub(r'^---+$', r'<hr/>', content, flags=re.MULTILINE)

# Simple table conversion
lines = content.split('\n')
result = []
in_table = False
table_rows = []

for line in lines:
    if '|' in line and line.strip().startswith('|'):
        if not in_table:
            in_table = True
            table_rows = []
        # Skip separator lines
        if re.match(r'^\|[\s\-:|]+\|$', line.strip()):
            continue
        cells = [c.strip() for c in line.strip().split('|')[1:-1]]
        table_rows.append(cells)
    else:
        if in_table:
            # Output table
            result.append('<table><tbody>')
            for i, row in enumerate(table_rows):
                tag = 'th' if i == 0 else 'td'
                result.append('<tr>' + ''.join(f'<{tag}>{c}</{tag}>' for c in row) + '</tr>')
            result.append('</tbody></table>')
            in_table = False
            table_rows = []
        result.append(line)

if in_table:
    result.append('<table><tbody>')
    for i, row in enumerate(table_rows):
        tag = 'th' if i == 0 else 'td'
        result.append('<tr>' + ''.join(f'<{tag}>{c}</{tag}>' for c in row) + '</tr>')
    result.append('</tbody></table>')

content = '\n'.join(result)

# Paragraphs - wrap non-tag lines
final_lines = []
for line in content.split('\n'):
    stripped = line.strip()
    if stripped and not stripped.startswith('<') and not stripped.endswith('>'):
        final_lines.append(f'<p>{line}</p>')
    else:
        final_lines.append(line)
content = '\n'.join(final_lines)

payload = {
    'type': 'page',
    'title': '''$current_title''',
    'version': {'number': $new_version},
    'body': {
        'storage': {
            'value': content,
            'representation': 'storage'
        }
    }
}

print(json.dumps(payload))
" | api_put "/rest/api/content/${page_id}" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'id' in data:
    print('Page updated successfully!')
    print('ID:', data['id'])
    print('Title:', data['title'])
    print('Version:', data.get('version', {}).get('number', 'Unknown'))
    link = data.get('_links', {}).get('webui', '')
    if link:
        print('URL: https://querypie.atlassian.net/wiki' + link)
else:
    print('Error:', data.get('message', 'Unknown error'))
"

else
  echo "Usage: confluence <command> [args]"
  echo ""
  echo "Commands:"
  echo "  spaces                                          List all global spaces"
  echo "  search <query>                                  Search pages"
  echo "  page <pageId>                                   View page content"
  echo "  create <spaceKey> <parentId> <title> <mdFile>   Create child page from markdown"
  echo "  update <pageId> <mdFile>                        Update page from markdown"
  echo ""
  echo "Configuration:"
  echo "  Set CONFLUENCE_CREDS=email:api_token or create ~/.config/atlassian/confluence.conf"
fi
