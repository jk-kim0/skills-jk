#!/bin/bash
#
# Pre-commit hook for skills-jk (Public repository)
# 민감 정보가 공개 repo에 커밋되는 것을 방지합니다.
#
# 설치: cp .github/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 경고 메시지 출력
warn() {
    echo -e "${YELLOW}⚠️  $1${NC}" >&2
}

# 에러 메시지 출력
error() {
    echo -e "${RED}❌ $1${NC}" >&2
}

# 커밋 대상 파일 목록
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_ISSUES=0

# 1. Slack 키워드 검사 (tasks/, projects/ 폴더만)
SLACK_PATTERNS="slack\.com|#[a-z0-9_-]+channel|from Slack|Slack 메시지|슬랙"

for file in $STAGED_FILES; do
    if [[ "$file" =~ ^(tasks|projects)/ ]]; then
        if grep -iEq "$SLACK_PATTERNS" "$file" 2>/dev/null; then
            error "Slack 관련 키워드 발견: $file"
            echo "   → 이 파일은 skills-jk-private repo에서 관리하세요."
            FOUND_ISSUES=1
        fi
    fi
done

# 2. Private repo 참조 검사 (새로 추가된 파일만)
NEW_FILES=$(git diff --cached --name-only --diff-filter=A)

for file in $NEW_FILES; do
    if [[ "$file" =~ ^(tasks|projects)/ ]] && [[ "$file" =~ \.md$ ]]; then
        # repo: 필드에서 GitHub URL 추출
        REPO_URL=$(grep -E "^repo:\s*https://github\.com/" "$file" 2>/dev/null | head -1 | sed 's/repo:\s*//' | tr -d ' ')

        if [ -n "$REPO_URL" ]; then
            # owner/repo 추출
            OWNER_REPO=$(echo "$REPO_URL" | sed -E 's|https://github\.com/([^/]+/[^/]+).*|\1|')

            if [ -n "$OWNER_REPO" ]; then
                # GitHub API로 visibility 확인
                VISIBILITY=$(gh api "repos/$OWNER_REPO" --jq '.visibility' 2>/dev/null || echo "unknown")

                if [ "$VISIBILITY" = "private" ]; then
                    error "Private repository 참조 발견: $file"
                    echo "   → repo: $REPO_URL (private)"
                    echo "   → 이 파일은 skills-jk-private repo에서 관리하세요."
                    FOUND_ISSUES=1
                elif [ "$VISIBILITY" = "unknown" ]; then
                    warn "Repository visibility 확인 불가: $OWNER_REPO"
                    echo "   → 수동으로 확인하세요: gh api repos/$OWNER_REPO --jq '.visibility'"
                fi
            fi
        fi
    fi
done

# 결과 처리
if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    error "민감 정보가 감지되었습니다. 커밋이 차단됩니다."
    echo ""
    echo "해결 방법:"
    echo "1. 해당 파일을 skills-jk-private repo로 이동하세요."
    echo "2. 또는 민감 정보를 제거하세요."
    echo ""
    echo "강제 커밋 (권장하지 않음): git commit --no-verify"
    exit 1
fi

exit 0
