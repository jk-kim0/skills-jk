#!/bin/bash
#
# create-pr.sh
#
# AI Agent ì‘ì—… ê²°ê³¼ì— ëŒ€í•œ PRì„ github-actions[bot]ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
#
# ì‚¬ìš©ë²•:
#   ./create-pr.sh <branch_prefix> <pr_title> [pr_body]
#
# í™˜ê²½ ë³€ìˆ˜:
#   GH_TOKEN: GitHub CLI ì¸ì¦ì„ ìœ„í•œ í† í°

set -o errexit -o nounset -o pipefail

BRANCH_PREFIX="${1:-task}"
PR_TITLE="${2:-chore: AI Agent automated changes}"
PR_BODY="${3:-Automated changes by AI Agent}"

# Git ì‚¬ìš©ì ì„¤ì • (github-actions[bot])
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"

# ë³€ê²½ì‚¬í•­ í™•ì¸
if ! git status --porcelain | grep -q .; then
  echo "No changes to commit"
  exit 0
fi

# ë¸Œëœì¹˜ ì´ë¦„ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„)
BRANCH_NAME="${BRANCH_PREFIX}/bot-$(date +%Y%m%d-%H%M%S)"

# ë¸Œëœì¹˜ ìƒì„± ë° ì²´í¬ì•„ì›ƒ
git checkout -b "$BRANCH_NAME"

# ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
git add -A

# ìŠ¤í…Œì´ì§•ëœ ë³€ê²½ì‚¬í•­ í™•ì¸
STAGED_FILES=$(git diff --cached --name-only)
if [[ -z "$STAGED_FILES" ]]; then
  echo "No staged changes"
  exit 0
fi

# ë³€ê²½ì‚¬í•­ ì •ë³´ ìˆ˜ì§‘
CHANGES_STATUS=$(git status --short)
CHANGES_STAT=$(git diff --cached --stat HEAD)

# ì»¤ë°‹
git commit -m "${PR_TITLE}

Co-Authored-By: Atlas <atlas@jk.agent>"

# ë¸Œëœì¹˜ í‘¸ì‹œ
if ! git push -u origin "$BRANCH_NAME"; then
  echo "Failed to push branch $BRANCH_NAME"
  exit 1
fi

# PR Description ìƒì„±
FULL_PR_BODY=$(cat <<EOF
## Summary

${PR_BODY}

## Changes

\`\`\`
${CHANGES_STATUS}
\`\`\`

## Statistics

\`\`\`
${CHANGES_STAT}
\`\`\`

---
ğŸ¤– Generated by github-actions[bot] with Atlas
EOF
)

# PR ìƒì„±
if ! gh pr create \
  --title "$PR_TITLE" \
  --body "$FULL_PR_BODY" \
  --base main \
  --head "$BRANCH_NAME"; then
  echo "Failed to create PR for branch $BRANCH_NAME"
  exit 1
fi

echo "Pull request created successfully for branch $BRANCH_NAME"
